name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/my-money
            git pull origin main
            docker compose down
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "âœ… Deploy completado"

      - name: Wait and show logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "â³ Esperando 15 segundos..."
            sleep 15
            echo "ğŸ“‹ Estado del contenedor:"
            docker ps | grep my-money || echo "âŒ Contenedor no encontrado"
            echo ""
            echo "ğŸ“‹ Ãšltimos logs:"
            docker logs --tail 50 my-money 2>&1 || echo "âŒ No se pudieron obtener logs"
