name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Verificar Traefik y red
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîç Verificando Traefik..."
            if ! docker ps | grep -q traefik; then
              echo "‚ö†Ô∏è Traefik no est√° corriendo"
            else
              echo "‚úÖ Traefik est√° corriendo"
            fi

            echo "üîç Verificando red traefik_network..."
            if ! docker network ls | grep -q traefik_network; then
              echo "üì¶ Creando red traefik_network..."
              docker network create traefik_network
            else
              echo "‚úÖ Red traefik_network existe"
            fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/my-money
            git pull origin main
            docker compose down
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "‚úÖ Deploy completado"
            echo "üîÑ Forzando recarga de Traefik..."
            docker restart traefik 2>/dev/null || echo "‚ö†Ô∏è No se pudo reiniciar Traefik (puede que no est√© corriendo o tenga otro nombre)"
            echo ""
            echo "üìã Verificando que el contenedor est√° en la red traefik_network:"
            docker inspect my-money --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}} {{end}}' || echo "‚ùå Error al verificar red"

      - name: Wait and show logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚è≥ Esperando 15 segundos..."
            sleep 15
            echo "üìã Estado del contenedor:"
            docker ps | grep my-money || echo "‚ùå Contenedor no encontrado"
            echo ""
            echo "üìã √öltimos logs:"
            docker logs --tail 50 my-money 2>&1 || echo "‚ùå No se pudieron obtener logs"
            echo ""
            echo "üîç Verificando conexi√≥n a Traefik:"
            docker network inspect traefik_network --format '{{range .Containers}}{{.Name}} {{end}}' || echo "‚ùå Error al inspeccionar red"
            echo ""
            echo "üìã Logs de Traefik (√∫ltimas 20 l√≠neas):"
            docker logs --tail 20 traefik 2>&1 || echo "‚ö†Ô∏è No se pudieron obtener logs de Traefik"
            echo ""
            echo "üîç Verificando si Traefik detecta my-money:"
            docker logs traefik 2>&1 | grep -i "my-money\|mymoney" | tail -5 || echo "‚ö†Ô∏è No se encontraron referencias a my-money en logs de Traefik"
            echo ""
            echo "üîç Probando conexi√≥n desde Traefik al contenedor:"
            docker exec traefik wget -q -O- --timeout=2 http://my-money:3000 2>&1 | head -3 || echo "‚ö†Ô∏è Traefik no puede alcanzar my-money:3000"
            echo ""
            echo "üîç Probando conexi√≥n directa al contenedor (puerto 3000):"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3000 || echo "‚ö†Ô∏è No se pudo conectar al puerto 3000"
            echo ""
            echo "üîç Verificando routers de Traefik para my-money:"
            docker exec traefik wget -q -O- http://localhost:8080/api/http/routers 2>/dev/null | grep -i "mymoney\|my-money" || echo "‚ö†Ô∏è No se encontraron routers en Traefik API"
