name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Verificar Traefik y red
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîç Verificando Traefik..."
            if ! docker ps | grep -q traefik; then
              echo "‚ö†Ô∏è Traefik no est√° corriendo"
            else
              echo "‚úÖ Traefik est√° corriendo"
              echo "üîç Verificando puertos de Traefik:"
              docker ps | grep traefik
              echo ""
              echo "üîç Verificando si Traefik escucha en puerto 80:"
              docker ps | grep traefik | grep -E "0.0.0.0:80->" && echo "‚úÖ Traefik est√° escuchando en puerto 80" || echo "‚ùå Traefik NO est√° escuchando en puerto 80"
              echo ""
              echo "üîç Verificando si Traefik escucha en puerto 443:"
              docker ps | grep traefik | grep -E "0.0.0.0:443->" && echo "‚úÖ Traefik est√° escuchando en puerto 443" || echo "‚ö†Ô∏è Traefik no escucha en puerto 443"
              echo ""
              echo "üîç Verificando puertos abiertos en el sistema:"
              netstat -tlnp | grep -E ":(80|443|8080)" || ss -tlnp | grep -E ":(80|443|8080)" || echo "‚ö†Ô∏è No se pudo verificar puertos"
            fi

            echo "üîç Verificando red traefik_network..."
            if ! docker network ls | grep -q traefik_network; then
              echo "üì¶ Creando red traefik_network..."
              docker network create traefik_network
            else
              echo "‚úÖ Red traefik_network existe"
            fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd ~/apps/my-money
            echo "üì• Actualizando c√≥digo..."
            git pull origin main

            echo "üî® Construyendo y desplegando..."
            docker compose down || true
            docker compose up -d --build --remove-orphans 2>&1

            echo "üßπ Limpiando im√°genes..."
            docker image prune -f

            echo "‚è≥ Esperando que el contenedor inicie..."
            sleep 10

            echo "üìã Estado del contenedor:"
            docker ps -a | grep my-money || echo "‚ùå Contenedor no existe"

            if docker ps | grep -q my-money; then
              echo "‚úÖ Contenedor est√° corriendo"
              echo "üîÑ Reiniciando Traefik..."
              docker restart traefik 2>/dev/null || echo "‚ö†Ô∏è No se pudo reiniciar Traefik"
              echo "üìã Verificando red:"
              docker inspect my-money --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}} {{end}}'
            else
              echo "‚ùå ERROR: Contenedor no est√° corriendo"
              echo "üìã Logs del build/contenedor:"
              docker logs my-money 2>&1 || echo "No hay logs disponibles"
              exit 1
            fi

      - name: Wait and show logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚è≥ Esperando 15 segundos..."
            sleep 15
            echo "üìã Estado del contenedor:"
            docker ps | grep my-money || echo "‚ùå Contenedor no encontrado"
            echo ""
            echo "üìã √öltimos logs:"
            docker logs --tail 50 my-money 2>&1 || echo "‚ùå No se pudieron obtener logs"
            echo ""
            echo "üîç Verificando conexi√≥n a Traefik:"
            docker network inspect traefik_network --format '{{range .Containers}}{{.Name}} {{end}}' || echo "‚ùå Error al inspeccionar red"
            echo ""
            echo "üìã Logs de Traefik (√∫ltimas 20 l√≠neas):"
            docker logs --tail 20 traefik 2>&1 || echo "‚ö†Ô∏è No se pudieron obtener logs de Traefik"
            echo ""
            echo "üîç Verificando si Traefik detecta my-money:"
            docker logs traefik 2>&1 | grep -i "my-money\|mymoney" | tail -5 || echo "‚ö†Ô∏è No se encontraron referencias a my-money en logs de Traefik"
            echo ""
            echo "üîç Probando conexi√≥n desde Traefik al contenedor:"
            docker exec traefik wget -q -O- --timeout=2 http://my-money:3000 2>&1 | head -3 || echo "‚ö†Ô∏è Traefik no puede alcanzar my-money:3000"
            echo ""
            echo "üîç Probando conexi√≥n directa al contenedor (puerto 3000):"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3000 || echo "‚ö†Ô∏è No se pudo conectar al puerto 3000"
            echo ""
            echo "üîç Verificando routers de Traefik para my-money:"
            docker exec traefik wget -q -O- http://localhost:8080/api/http/routers 2>/dev/null | grep -i "mymoney\|my-money" || echo "‚ö†Ô∏è No se encontraron routers en Traefik API"
            echo ""
            echo "üîç Verificando servicios de Traefik:"
            docker exec traefik wget -q -O- http://localhost:8080/api/http/services 2>/dev/null | grep -i "mymoney\|my-money" || echo "‚ö†Ô∏è No se encontraron servicios en Traefik API"
            echo ""
            echo "üîç Verificando labels del contenedor my-money:"
            docker inspect my-money --format '{{range .Config.Labels}}{{.}}{{"\n"}}{{end}}' | grep traefik || echo "‚ö†Ô∏è No se encontraron labels de Traefik"
            echo ""
            echo "üîç Verificando IP del contenedor en traefik_network:"
            docker inspect my-money --format '{{range $net, $conf := .NetworkSettings.Networks}}{{if eq $net "traefik_network"}}IP: {{$conf.IPAddress}}{{end}}{{end}}' || echo "‚ö†Ô∏è Error al obtener IP"
            echo ""
            echo "üîç Probando acceso a mymoney.sebastianlabs.tech desde Traefik:"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -H "Host: mymoney.sebastianlabs.tech" http://localhost/ 2>&1 || echo "‚ö†Ô∏è No se pudo probar la ruta"
            echo ""
            echo "üîç Verificando DNS del subdominio:"
            nslookup mymoney.sebastianlabs.tech 2>/dev/null || dig mymoney.sebastianlabs.tech +short 2>/dev/null || echo "‚ö†Ô∏è No se pudo verificar DNS"
            echo ""
            echo "üîç Verificando firewall (ufw):"
            sudo ufw status 2>/dev/null || echo "‚ö†Ô∏è ufw no est√° disponible o requiere permisos"
            echo ""
            echo "üîç Verificando si el puerto 80 est√° abierto externamente:"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -m 5 http://138.68.227.88/ 2>&1 || echo "‚ö†Ô∏è No se pudo conectar al puerto 80 desde el servidor"
            echo ""
            echo "üîç Verificando certificado SSL del subdominio:"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -k -m 5 https://mymoney.sebastianlabs.tech/ 2>&1 || echo "‚ö†Ô∏è No se pudo verificar HTTPS del subdominio"
            echo ""
            echo "üîç Verificando configuraci√≥n de Traefik (entrypoints):"
            docker exec traefik cat /etc/traefik/traefik.yml 2>/dev/null | grep -A 5 entrypoints || docker exec traefik cat /traefik.yml 2>/dev/null | grep -A 5 entrypoints || echo "‚ö†Ô∏è No se pudo leer configuraci√≥n de Traefik"
