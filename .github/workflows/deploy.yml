name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Verificar Traefik y red
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîç Verificando Traefik..."
            if ! docker ps | grep -q traefik; then
              echo "‚ö†Ô∏è Traefik no est√° corriendo"
            else
              echo "‚úÖ Traefik est√° corriendo"
            fi

            echo "üîç Verificando red traefik_network..."
            if ! docker network ls | grep -q traefik_network; then
              echo "üì¶ Creando red traefik_network..."
              docker network create traefik_network
            else
              echo "‚úÖ Red traefik_network existe"
            fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/my-money
            git pull origin main
            docker compose down
            docker compose up -d --build --remove-orphans
            docker image prune -f
            echo "‚úÖ Deploy completado"

      - name: Wait and show logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚è≥ Esperando 15 segundos..."
            sleep 15
            echo "üìã Estado del contenedor:"
            docker ps | grep my-money || echo "‚ùå Contenedor no encontrado"
            echo ""
            echo "üìã √öltimos logs:"
            docker logs --tail 50 my-money 2>&1 || echo "‚ùå No se pudieron obtener logs"
            echo ""
            echo "üîç Verificando conexi√≥n a Traefik:"
            docker network inspect traefik_network --format '{{range .Containers}}{{.Name}} {{end}}' || echo "‚ùå Error al inspeccionar red"
            echo ""
            echo "üìã Logs de Traefik (√∫ltimas 20 l√≠neas):"
            docker logs --tail 20 traefik 2>&1 || echo "‚ö†Ô∏è No se pudieron obtener logs de Traefik"
